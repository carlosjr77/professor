<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor IA - Ambiente Seguro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #004d99; 
            --bg: #f0f2f5; 
            --mic-on: #ff4b4b; 
            --cam-border: #ff0000;
        }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden; /* Evita barras de rolagem na p√°gina inteira */
        }
        
        /* --- CAMERA DE SEGURAN√áA (NOVO) --- */
        #security-cam {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 135px;
            background: black;
            border: 3px solid var(--cam-border);
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        #security-cam video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #rec-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            color: red;
            font-weight: bold;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 4px;
            animation: blink 1s infinite;
        }

        @keyframes blink { 50% { opacity: 0; } }

        /* --- √ÅREA DO CHAT --- */
        #chat-wrapper { 
            width: 100%; 
            max-width: 800px; 
            background: white; 
            height: 90vh; 
            margin-top: 20px; 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        
        #header { 
            background: var(--primary); 
            color: white; 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            padding-bottom: 80px; /* Espa√ßo para n√£o cobrir com a camera em telas pequenas */
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 80%; line-height: 1.5; }
        .user { align-self: flex-end; background: #e6f7ff; border: 1px solid #b3e0ff; }
        .ai { align-self: flex-start; background: #fff5cc; border: 1px solid #ffeebb; }
        
        #controls { 
            padding: 20px; 
            background: #fff; 
            border-top: 1px solid #eee; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        
        /* Bot√µes */
        .btn { padding: 12px 20px; border: none; border-radius: 25px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        #send-btn { background: var(--primary); }
        #quiz-btn { background: #28a745; }
        
        /* Bot√£o do Microfone (Liga/Desliga) */
        #mic-btn { 
            background: #ccc; /* Cinza = Desligado */
            width: 50px; height: 50px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 1.2em;
            transition: all 0.3s;
        }
        #mic-btn.listening { 
            background: var(--mic-on); /* Vermelho = Ligado */
            box-shadow: 0 0 10px var(--mic-on);
            animation: pulse 1.5s infinite; 
        }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="security-cam">
        <div id="rec-indicator">‚óè REC</div>
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <div id="chat-wrapper">
        <div id="header">
            <span>üéì Tutor de Ci√™ncias IA</span>
            <div style="font-size: 0.8em; opacity: 0.8;">Monitorado</div>
        </div>
        
        <div id="messages">
            <div class="msg ai">Ol√°! Sua c√¢mera foi ativada para seguran√ßa da avalia√ß√£o. Posso ajudar com d√∫vidas ou gerar um quiz?</div>
        </div>
        
        <div id="controls">
            <button id="mic-btn" class="btn" title="Ativar/Desativar Voz"><i class="fas fa-microphone"></i></button>
            
            <input type="text" id="user-input" placeholder="Digite ou fale...">
            <button id="send-btn" class="btn"><i class="fas fa-paper-plane"></i></button>
            <button id="quiz-btn" class="btn">Quiz</button>
        </div>
    </div>

    <script>
        const BACKEND = 'http://127.0.0.1:5000';
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const micBtn = document.getElementById('mic-btn');
        
        // --- 1. ATIVA√á√ÉO DA C√ÇMERA (Proctoring) ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const videoElement = document.getElementById('webcam');
                videoElement.srcObject = stream;
            } catch (e) {
                alert("üö® ALERTA DE SEGURAN√áA: N√£o foi poss√≠vel acessar sua c√¢mera. Verifique as permiss√µes. O teste pode ser invalidado.");
                // Aqui voc√™ poderia bloquear o acesso se fosse rigoroso
            }
        }
        // Inicia a c√¢mera assim que a p√°gina carrega
        window.addEventListener('load', startCamera);


        // --- 2. CONFIGURA√á√ÉO DE VOZ (Liga/Desliga) ---
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new Recognition();
        recognition.lang = 'pt-BR';
        recognition.continuous = false; 

        const synth = window.speechSynthesis;
        let isVoiceActive = false; // Come√ßa desligado (Sil√™ncio)

        micBtn.addEventListener('click', () => {
            if (!isVoiceActive) {
                // LIGAR VOZ
                isVoiceActive = true;
                micBtn.classList.add('listening'); // Fica vermelho
                try { recognition.start(); } catch(e){}
            } else {
                // DESLIGAR VOZ
                isVoiceActive = false;
                micBtn.classList.remove('listening'); // Fica cinza
                recognition.stop();
                synth.cancel(); // Cala a boca da IA imediatamente
            }
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            sendMessage();
        };

        recognition.onend = () => {
            // S√≥ reinicia o microfone se o bot√£o ainda estiver LIGADO (Vermelho) e a IA n√£o estiver falando
            if (isVoiceActive && !synth.speaking) {
                try { recognition.start(); } catch(e){}
            }
        };

        function speakText(text) {
            // S√≥ fala se o bot√£o estiver LIGADO
            if (!isVoiceActive) return;
            
            recognition.stop(); // Pausa mic para n√£o dar eco
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            
            utterance.onend = () => {
                if (isVoiceActive) try { recognition.start(); } catch(e){}
            };
            synth.speak(utterance);
        }


        // --- 3. L√ìGICA DO CHAT E QUIZ ---
        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.textContent = text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMsg(text, 'user');
            userInput.value = '';

            try {
                const res = await fetch(`${BACKEND}/ask_tutor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pergunta: text })
                });
                const data = await res.json();
                addMsg(data.resposta, 'ai');
                speakText(data.resposta); 

            } catch (e) {
                addMsg("Erro ao conectar com o servidor.", 'ai');
            }
        }

        document.getElementById('quiz-btn').addEventListener('click', async () => {
            const topic = userInput.value.trim();
            if (!topic) {
                alert("Digite um t√≥pico para o quiz (ex: '√Åtomos').");
                return;
            }
            addMsg(`Gerando quiz sobre: ${topic}...`, 'user');
            
            try {
                const res = await fetch(`${BACKEND}/generate_quiz`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topico: topic })
                });
                const data = await res.json();
                addMsg(data.quiz, 'ai');
                speakText("Preparei um quiz para voc√™. Confira a resposta correta.");
            } catch (e) {
                addMsg("Erro ao gerar quiz.", 'ai');
            }
        });

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage() });


        // --- 4. SEGURAN√áA (Aba e Copiar) ---
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                alert("‚ö†Ô∏è ALERTA: Voc√™ saiu da aba da prova! O incidente foi registrado.");
            }
        });
        document.addEventListener('copy', (e) => { e.preventDefault(); alert("Copiar √© proibido!"); });

    </script>
</body>
</html>